name: Update Document Metadata

on:
  push:
    paths:
      - 'documents/*.html'
      - 'documents/*.htm'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã—ã¦ãŠã

jobs:
  extract-metadata:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install cheerio
      
      - name: Extract HTML metadata
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const cheerio = require('cheerio');
          
          // documentsãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
          const docsDir = path.join(process.cwd(), 'documents');
          const metadataFile = path.join(docsDir, 'metadata.json');
          
          // æ—¢å­˜ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
          let metadata = {};
          if (fs.existsSync(metadataFile)) {
            try {
              metadata = JSON.parse(fs.readFileSync(metadataFile, 'utf-8'));
            } catch (e) {
              console.log('æ—¢å­˜ã®metadata.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚');
            }
          }
          
          // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          const htmlFiles = fs.readdirSync(docsDir)
            .filter(file => file.endsWith('.html') || file.endsWith('.htm'));
          
          console.log(`Found ${htmlFiles.length} HTML files`);
          
          // å„HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
          htmlFiles.forEach(file => {
            const filePath = path.join(docsDir, file);
            const content = fs.readFileSync(filePath, 'utf-8');
            const $ = cheerio.load(content);
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦ã™ï¼‰
            let title = $('title').text().trim() || 
                       $('h1').first().text().trim() || 
                       $('meta[property="og:title"]').attr('content') ||
                       file.replace(/\.[^/.]+$/, '');
            
            // èª¬æ˜ã‚’å–å¾—
            let description = $('meta[name="description"]').attr('content') || 
                            $('meta[property="og:description"]').attr('content') || 
                            '';
            
            // ä½œæˆè€…ã‚’å–å¾—
            let author = $('meta[name="author"]').attr('content') || '';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
            const stats = fs.statSync(filePath);
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ›´æ–°æ—¥æ™‚ã®ã¿æ›´æ–°ï¼‰
            if (metadata[file]) {
              metadata[file].title = title;
              metadata[file].description = description;
              metadata[file].author = author || metadata[file].author;
              metadata[file].lastModified = stats.mtime.toISOString();
              metadata[file].size = stats.size;
            } else {
              metadata[file] = {
                title: title,
                description: description,
                author: author,
                created: stats.birthtime.toISOString(),
                lastModified: stats.mtime.toISOString(),
                size: stats.size
              };
            }
            
            console.log(`Processed: ${file} -> "${title}"`);
          });
          
          // å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
          Object.keys(metadata).forEach(file => {
            if (!htmlFiles.includes(file)) {
              delete metadata[file];
              console.log(`Removed: ${file} (file no longer exists)`);
            }
          });
          
          // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä¿å­˜
          fs.writeFileSync(
            metadataFile, 
            JSON.stringify(metadata, null, 2),
            'utf-8'
          );
          
          console.log('Metadata updated successfully!');
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add documents/metadata.json
            git commit -m "ğŸ”„ Auto-update document metadata"
            git push
          fi
